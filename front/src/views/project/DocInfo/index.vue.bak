<template>
  <div>
    <el-container>
      <el-aside width="300px" style="border-right: 1px solid #eee;padding-right: 20px;">
        <el-input
          v-show="treeData.length > 0"
          v-model="filterText"
          prefix-icon="el-icon-search"
          placeholder="搜索:文档名称、请求地址"
          style="margin-bottom: 10px;"
          size="mini"
          clearable
        />
        <el-tree
          ref="tree"
          :data="treeData"
          :props="defaultProps"
          :filter-node-method="filterNode"
          node-key="id"
          default-expand-all
          highlight-current
          empty-text="暂无文档"
          @current-change="onDocSelect"
        />
      </el-aside>
      <el-main style="padding-top: 0">
        <doc-view v-show="docId > 0" :id="docId"></doc-view>
      </el-main>
    </el-container>
  </div>
</template>

<script>
import DocView from '../DocView'

export default {
  name: 'DocInfo',
  components: { DocView },
  props: {
    moduleId: {
      type: Number,
      default: 0
    }
  },
  data() {
    return {
      treeData: [],
      filterText: '',
      defaultProps: {
        children: 'children',
        label: 'name'
      },
      docId: 0,
      viewDialogData: {
        routeId: 0
      }
    }
  },
  watch: {
    filterText(val) {
      this.$refs.tree.filter(val)
    },
    moduleId(id) {
      this.loadTree(id)
    }
  },
  created() {
  },
  methods: {
    loadTree: function(moduleId) {
      if (moduleId > 0) {
        this.get('/doc/list', { moduleId: moduleId }, function(resp) {
          const data = resp.data
          this.treeData = this.convertTree(data)
        })
      }
    },
    // 树搜索
    filterNode(value, data) {
      if (!value) return true
      value = value.toLowerCase()
      return (data.name && data.name.toLowerCase().indexOf(value) !== -1) || (data.url && data.url.toLowerCase().indexOf(value) > -1)
    },
    onDocSelect: function(currentNode, beforeNode) {
      this.showDoc(currentNode)
    },
    showDoc: function(node) {
      if (node.children.length === 0) {
        this.docId = node.id
      }
    }
  }
}
</script>
